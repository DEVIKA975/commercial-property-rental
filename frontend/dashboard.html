<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | ARKA Realty</title>
    
    <script src="js/config.js"></script>
    <script>
        const API_BASE = 'http://localhost:4000'; 
        const token = localStorage.getItem('adminToken');
        if (!token) console.warn("No token found.");
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- [CSS STYLES] --- */
        :root {
            --sidebar-bg: #1e293b; --sidebar-width: 260px; --primary: #C5A059; --primary-hover: #b08d4b;
            --bg-body: #F3F4F6; --bg-card: #ffffff; --text-main: #1f2937; --text-muted: #6b7280; --border: #e5e7eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
        
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding: 20px; height: 100vh; flex-shrink: 0; }
        .logo-area { display: flex; justify-content: center; align-items: center; padding: 10px 0; }
        .logo-img { max-width: 100%; height: auto; max-height: 150px; object-fit: contain; }
        .nav-menu { list-style: none; flex: 1; margin-top: 20px; }
        .nav-item { margin-bottom: 8px; }
        .nav-link { display: flex; align-items: center; padding: 12px 16px; color: #94a3b8; text-decoration: none; border-radius: 8px; transition: 0.3s; font-size: 0.95rem; }
        .nav-link i { width: 25px; margin-right: 10px; }
        .nav-link:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-link.active { background: linear-gradient(90deg, rgba(197, 160, 89, 0.2) 0%, rgba(197, 160, 89, 0) 100%); color: var(--primary); border-left: 3px solid var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-bar { background: var(--bg-card); height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; border-bottom: 1px solid var(--border); }
        .page-title { font-size: 1.25rem; font-weight: 600; }
        .user-menu { display: flex; align-items: center; gap: 20px; }
        .profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .content-area { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* Table Styles */
        .table-card { background: var(--bg-card); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 20px; }
        .table-controls { display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .search-wrap { position: relative; width: 300px; }
        .search-wrap input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid var(--border); border-radius: 6px; background: #f9fafb; }
        .search-wrap i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .custom-select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: #fff; color: var(--text-main); }
        .btn-gold { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: var(--text-muted); font-weight: 500; font-size: 0.85rem; border-bottom: 1px solid var(--border); }
        td { padding: 15px; vertical-align: middle; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; }
        
        /* Badges */
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge.active { background: #dcfce7; color: #166534; }
        .badge.inactive { background: #f3f4f6; color: #374151; }
        
        /* Status Badges for Content */
        .badge.draft { background: #f1f5f9; color: #475569; }       /* Gray */
        .badge.published { background: #dcfce7; color: #166534; }   /* Green */
        .badge.archived { background: #fee2e2; color: #991b1b; }    /* Red */

        /* Status Badges for Leads */
        .badge.new { background: #dcfce7; color: #166534; }       
        .badge.contacted { background: #dbeafe; color: #1e40af; } 
        .badge.qualified { background: #f3e8ff; color: #6b21a8; } 
        .badge.lost { background: #fee2e2; color: #991b1b; }      
        
        .action-btn { background: none; border: 1px solid var(--border); padding: 6px; border-radius: 4px; color: var(--text-muted); cursor: pointer; margin-right: 5px; }
        .action-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        /* Modal & Forms */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 800px; max-width: 95%; max-height: 90vh; overflow-y: auto; border-radius: 12px; padding: 30px; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;}
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-section { margin-bottom: 25px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; }
        .form-section h3 { font-size: 1.1rem; color: var(--text-main); margin: 0 0 15px 0; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; font-weight: 600; }
        .form-group, .grid-2 > div { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; margin-bottom: 5px; font-weight: 600; color: var(--text-main); }
        .form-control, input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; font-family: inherit; }
        
        .cat-group { display: none; }
        .cat-group.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
        
        .gallery-preview { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; border-top: 1px dashed #e2e8f0; margin-top: 10px; }
        .thumb { height: 70px; width: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .btn-secondary { background: white; border: 1px solid #cbd5e1; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px; }

        /* Dashboard specific */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
        .stat-icon { width: 40px; height: 40px; background: #fdf6e7; color: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo-area">
            <img src="images/Arkafooter.png" alt="ARKA Logo" class="logo-img">
        </div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="#" class="nav-link active" onclick="navigate('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="navigate('properties', this)"><i class="fas fa-building"></i> Properties</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="navigate('users', this)"><i class="fas fa-users"></i> Users</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="navigate('leads', this)"><i class="fas fa-paper-plane"></i> Leads</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="navigate('content', this)"><i class="fas fa-file-alt"></i> Content</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="navigate('settings', this)"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
        <div style="margin-top: auto;">
             <a href="#" class="nav-link" onclick="logout()" style="color: #ef4444;"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </aside>

    <div class="main-content">
        <header class="top-bar">
            <h2 class="page-title" id="pageTitle">Dashboard</h2>
            <div class="user-menu">
                <div class="profile"><img src="https://i.pravatar.cc/150?img=11" alt="Admin" style="width:36px;height:36px;border-radius:50%"></div>
            </div>
        </header>

        <div class="content-area" id="mainContainer">
            </div>
    </div>

    <div id="genericModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Edit</h3>
                <button onclick="closeModal()" style="border:none;background:none;font-size:1.2rem;cursor:pointer">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let leadsData = [];
        let propertiesData = [];
        let usersData = [];
        let contentData = [];

        // --- NAVIGATION LOGIC ---
        function navigate(view, element) {
            if(element) {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }
            const container = document.getElementById('mainContainer');
            document.getElementById('pageTitle').innerText = view.charAt(0).toUpperCase() + view.slice(1);
            container.innerHTML = '<p style="text-align:center; padding:20px;">Loading...</p>';

            if(view === 'dashboard') { fetchProperties().then(() => renderDashboard(container)); }
            else if (view === 'properties') { fetchProperties().then(() => renderProperties(container)); }
            else if (view === 'users') { fetchUsers().then(() => renderUsers(container)); }
            else if (view === 'leads') { fetchLeads().then(() => renderLeads(container)); }
            else if (view === 'content') { fetchContent().then(() => renderContent(container)); }
            else if (view === 'settings') { renderSettings(container); }
        }

        // --- API CALLS ---
        async function fetchLeads() {
            try {
                const res = await fetch(`${API_BASE}/admin/leads`, { headers: { 'Authorization': `Bearer ${token}` } });
                leadsData = res.ok ? await res.json() : [];
                return leadsData;
            } catch (e) { return []; }
        }
        async function fetchUsers() {
            try {
                const res = await fetch(`${API_BASE}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                usersData = res.ok ? await res.json() : [];
                return usersData;
            } catch (e) { return []; }
        }
        async function fetchProperties() {
            try {
                const res = await fetch(`${API_BASE}/api/properties`);
                propertiesData = res.ok ? await res.json() : [];
                return propertiesData;
            } catch (e) { return []; }
        }
        async function fetchContent() {
            try {
                const res = await fetch(`${API_BASE}/admin/content`, { headers: { 'Authorization': `Bearer ${token}` } });
                contentData = res.ok ? await res.json() : [];
                return contentData;
            } catch (e) { return []; }
        }

        // --- RENDER FUNCTIONS ---

        // 1. Dashboard
        function renderDashboard(container) {
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-building"></i></div><div><div class="stat-label">Properties</div><div class="stat-value">${propertiesData.length}</div></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-user-friends"></i></div><div><div class="stat-label">Leads</div><div class="stat-value">${leadsData.length || '0'}</div></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-file-alt"></i></div><div><div class="stat-label">Content</div><div class="stat-value">${contentData.length || '0'}</div></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-dollar-sign"></i></div><div><div class="stat-label">Revenue</div><div class="stat-value">$1.2M</div></div></div>
                </div>
            `;
        }

        // --- CONTENT PAGE (New) ---
        function renderContent(container) {
            container.innerHTML = `
                <div class="table-card">
                    <div class="table-controls">
                        <div class="search-wrap"><i class="fas fa-search"></i><input type="text" id="contentSearch" placeholder="Search by Title, Category or Author" onkeyup="filterTable('contentTableBody')"></div>
                        <div style="display:flex; gap:10px;">
                            <select class="custom-select"><option>Filter by Status</option></select>
                            <button class="btn-gold" onclick="openContentModal('add')">Add Content</button>
                        </div>
                    </div>
                    <table>
                        <thead><tr><th>Title</th><th>Category</th><th>Author</th><th>Date Published</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="contentTableBody">
                            ${contentData.map(c => `
                                <tr>
                                    <td>${c.title}</td>
                                    <td><strong>${c.category}</strong></td>
                                    <td><div style="display:flex;align-items:center;gap:10px;"><img src="https://ui-avatars.com/api/?name=${c.author}&background=random" style="width:24px;border-radius:50%"> ${c.author}</div></td>
                                    <td>${c.date || '-'}</td>
                                    <td><span class="badge ${c.status.toLowerCase()}">${c.status}</span></td>
                                    <td>
                                        <button class="action-btn" onclick="openContentModal('edit', '${c._id}')"><i class="fas fa-edit"></i></button>
                                        <button class="action-btn" onclick="deleteContent('${c._id}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- CONTENT MODAL & LOGIC ---
        function openContentModal(mode, id) {
            const modal = document.getElementById('genericModal');
            document.getElementById('modalTitle').innerText = mode === 'add' ? 'Add Content' : 'Edit Content';
            let data = mode === 'edit' ? (contentData.find(c => c._id === id) || {}) : {};

            document.getElementById('modalBody').innerHTML = `
                <form onsubmit="event.preventDefault(); saveContent('${mode}', '${id || ''}');">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="cTitle" class="form-control" required value="${data.title || ''}">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Category</label>
                            <select id="cCategory" class="form-control">
                                <option ${data.category==='Blog Post'?'selected':''}>Blog Post</option>
                                <option ${data.category==='Article'?'selected':''}>Article</option>
                                <option ${data.category==='Report'?'selected':''}>Report</option>
                                <option ${data.category==='News'?'selected':''}>News</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="cStatus" class="form-control">
                                <option ${data.status==='Draft'?'selected':''}>Draft</option>
                                <option ${data.status==='Published'?'selected':''}>Published</option>
                                <option ${data.status==='Archived'?'selected':''}>Archived</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Author Name</label>
                            <input type="text" id="cAuthor" class="form-control" required value="${data.author || ''}">
                        </div>
                        <div class="form-group">
                            <label>Date Published</label>
                            <input type="date" id="cDate" class="form-control" value="${data.date || ''}">
                        </div>
                    </div>
                    <div style="text-align:right; margin-top:20px;">
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn-gold">Save Content</button>
                    </div>
                </form>
            `;
            modal.style.display = 'flex';
        }

        async function saveContent(mode, id) {
            const payload = {
                title: document.getElementById('cTitle').value,
                category: document.getElementById('cCategory').value,
                author: document.getElementById('cAuthor').value,
                date: document.getElementById('cDate').value,
                status: document.getElementById('cStatus').value
            };
            const method = mode === 'add' ? 'POST' : 'PUT';
            const url = mode === 'add' ? `${API_BASE}/admin/content` : `${API_BASE}/admin/content/${id}`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if(res.ok) { closeModal(); navigate('content'); } 
                else { alert('Error saving content'); }
            } catch(e) { alert('Network Error'); }
        }

        async function deleteContent(id) {
            if(!confirm('Delete this content?')) return;
            await fetch(`${API_BASE}/admin/content/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }});
            navigate('content');
        }

        // --- [EXISTING FUNCTIONS FOR PROPERTIES, USERS, LEADS] ---
        function renderProperties(container) {
            container.innerHTML = `
                <div class="table-card">
                    <div class="table-controls">
                        <div class="search-wrap"><i class="fas fa-search"></i><input type="text" id="propSearch" placeholder="Search..." onkeyup="filterTable('propTableBody')"></div>
                        <button class="btn-gold" onclick="openPropModal('add')"><i class="fas fa-plus"></i> Add Property</button>
                    </div>
                    <table>
                        <thead><tr><th>Image</th><th>Title</th><th>Location</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="propTableBody">
                            ${propertiesData.map(p => `
                                <tr>
                                    <td><img src="${(p.images && p.images[0]) || p.imageUrl || 'https://via.placeholder.com/50'}" class="prop-thumb"></td>
                                    <td><strong>${p.title}</strong><br><small>${p.category}</small></td>
                                    <td>${p.location || '-'}</td>
                                    <td><strong>${p.price || '-'}</strong></td>
                                    <td><span class="badge active">${p.tag || 'Active'}</span></td>
                                    <td><button class="action-btn" onclick="openPropModal('edit', '${p._id}')"><i class="fas fa-edit"></i></button><button class="action-btn" onclick="deleteProp('${p._id}')"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderUsers(container) {
            container.innerHTML = `
                <div class="table-card">
                    <div class="table-controls">
                        <div class="search-wrap"><i class="fas fa-search"></i><input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterTable('userTableBody')"></div>
                        <button class="btn-gold" onclick="openUserModal('add')"><i class="fas fa-plus"></i> Add User</button>
                    </div>
                    <table>
                        <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="userTableBody">
                            ${usersData.map(u => `
                                <tr>
                                    <td><div style="display:flex;align-items:center;gap:10px;"><img src="https://ui-avatars.com/api/?name=${u.name}&background=random" style="width:30px;border-radius:50%"> <strong>${u.name}</strong></div></td>
                                    <td>${u.email}</td>
                                    <td><strong>${u.role}</strong></td>
                                    <td><span class="badge ${u.status === 'Active' ? 'active' : 'inactive'}">${u.status}</span></td>
                                    <td><button class="action-btn" onclick="openUserModal('edit', '${u._id}')"><i class="fas fa-edit"></i></button><button class="action-btn" onclick="deleteUser('${u._id}')"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderLeads(container) {
            container.innerHTML = `
                <div class="table-card">
                    <div class="table-controls">
                        <div class="search-wrap"><i class="fas fa-search"></i><input type="text" id="leadSearch" placeholder="Search leads..." onkeyup="filterTable('leadTableBody')"></div>
                        <button class="btn-gold" onclick="openLeadModal('add')">Add Lead</button>
                    </div>
                    <table>
                        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Source</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="leadTableBody">
                            ${leadsData.map(l => `
                                <tr>
                                    <td><div style="display:flex;align-items:center;gap:10px;"><img src="https://ui-avatars.com/api/?name=${l.name}&background=random" style="width:30px;border-radius:50%"> <strong>${l.name}</strong></div></td>
                                    <td>${l.email}</td>
                                    <td>${l.phone || '-'}</td>
                                    <td>${l.source}</td>
                                    <td><span class="badge ${l.status.toLowerCase()}">${l.status}</span></td>
                                    <td><button class="action-btn" onclick="openLeadModal('edit', '${l._id}')"><i class="fas fa-edit"></i></button><button class="action-btn" onclick="deleteLead('${l._id}')"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- PROPERTY MODAL & LOGIC ---
        function openPropModal(mode, id) {
            const modal = document.getElementById('genericModal');
            document.getElementById('modalTitle').innerText = mode === 'add' ? 'Add New Property' : 'Edit Property';
            let data = mode === 'edit' ? (propertiesData.find(p => p._id === id) || {}) : {};
            document.getElementById('modalBody').innerHTML = `
                <form onsubmit="event.preventDefault(); saveProperty('${mode}', '${id || ''}');">
                    <div class="form-section">
                        <h3>Core Details</h3>
                        <div class="grid-2">
                            <div><label>Category</label><select id="catSelect" class="form-control" onchange="toggleFields()"><option value="Office">Office</option><option value="Retail">Retail</option><option value="Warehouse">Warehouse</option></select></div>
                            <div><label>Title</label><input type="text" id="propTitle" class="form-control" required value="${data.title || ''}"></div>
                            <div><label>Status</label><select id="propStatus" class="form-control"><option>Active</option><option>Draft</option></select></div>
                        </div>
                        <div style="margin-top:15px"><label>Image</label><input type="file" id="imageFiles" onchange="previewFiles()"><input type="hidden" id="existingImg" value="${(data.images && data.images[0]) || data.imageUrl || ''}"><div id="galleryPreview"></div></div>
                    </div>
                    <div id="OfficeFields" class="cat-group active"><div class="form-section"><h3>Details</h3><div class="grid-2"><div><label>Address</label><input type="text" id="officeAddr" class="form-control" value="${data.location||''}"></div><div><label>Price</label><input type="text" id="officePrice" class="form-control" value="${data.price||''}"></div></div></div></div>
                    <div style="text-align:right; margin-top:20px;">
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn-gold">Save Property</button>
                    </div>
                </form>
            `;
            if(data.category) { document.getElementById('catSelect').value = data.category; toggleFields(); }
            modal.style.display = 'flex';
        }
        async function saveProperty(mode, id) {
            const payload = { title: document.getElementById('propTitle').value, category: document.getElementById('catSelect').value, location: document.getElementById('officeAddr').value, price: document.getElementById('officePrice').value, images: [] };
            const fileInput = document.getElementById('imageFiles');
            const existingImg = document.getElementById('existingImg').value;
            
            if(fileInput.files.length > 0) {
                const base64 = await toBase64(fileInput.files[0]);
                payload.images.push(base64); payload.imageUrl = base64;
            } else if(existingImg) { payload.images.push(existingImg); payload.imageUrl = existingImg; }

            const method = mode === 'add' ? 'POST' : 'PUT';
            const url = mode === 'add' ? `${API_BASE}/admin/properties` : `${API_BASE}/admin/properties/${id}`;
            await fetch(url, { method, headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${token}`}, body: JSON.stringify(payload) });
            closeModal(); navigate('properties');
        }
        async function deleteProp(id) { if(!confirm('Delete?')) return; await fetch(`${API_BASE}/admin/properties/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }}); navigate('properties'); }

        // --- USER MODAL & LOGIC ---
        function openUserModal(mode, id) {
            const modal = document.getElementById('genericModal');
            document.getElementById('modalTitle').innerText = mode === 'add' ? 'Add New User' : 'Edit User';
            let data = mode === 'edit' ? (usersData.find(u => u._id === id) || {}) : {};
            document.getElementById('modalBody').innerHTML = `
                <form onsubmit="event.preventDefault(); saveUser('${mode}', '${id || ''}');">
                    <div class="grid-2">
                        <div><label>Full Name</label><input type="text" id="uName" class="form-control" required value="${data.name || ''}"></div>
                        <div><label>Email</label><input type="email" id="uEmail" class="form-control" required value="${data.email || ''}"></div>
                        <div><label>Role</label><select id="uRole" class="form-control"><option>Admin</option><option>Editor</option><option>Agent</option></select></div>
                        <div><label>Status</label><select id="uStatus" class="form-control"><option>Active</option><option>Inactive</option></select></div>
                        ${mode === 'add' ? '<div><label>Password</label><input type="password" id="uPass" class="form-control" required></div>' : ''}
                    </div>
                    <div style="text-align:right; margin-top:20px;"><button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button><button type="submit" class="btn-gold">Save User</button></div>
                </form>
            `;
            modal.style.display = 'flex';
        }
        async function saveUser(mode, id) {
            const payload = { name: document.getElementById('uName').value, email: document.getElementById('uEmail').value, role: document.getElementById('uRole').value, status: document.getElementById('uStatus').value };
            if(mode === 'add') payload.password = document.getElementById('uPass').value;
            const method = mode === 'add' ? 'POST' : 'PUT';
            const url = mode === 'add' ? `${API_BASE}/admin/users` : `${API_BASE}/admin/users/${id}`;
            await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
            closeModal(); navigate('users');
        }
        async function deleteUser(id) { if(!confirm('Delete?')) return; await fetch(`${API_BASE}/admin/users/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }}); navigate('users'); }

        // --- LEAD MODAL & LOGIC ---
        function openLeadModal(mode, id) {
            const modal = document.getElementById('genericModal');
            document.getElementById('modalTitle').innerText = mode === 'add' ? 'Add New Lead' : 'Edit Lead';
            let data = mode === 'edit' ? (leadsData.find(l => l._id === id) || {}) : {};
            document.getElementById('modalBody').innerHTML = `
                <form onsubmit="event.preventDefault(); saveLead('${mode}', '${id || ''}');">
                    <div class="grid-2"><div><label>Full Name</label><input type="text" id="lName" class="form-control" required value="${data.name || ''}"></div><div><label>Email</label><input type="email" id="lEmail" class="form-control" required value="${data.email || ''}"></div></div>
                    <div class="grid-2"><div><label>Phone</label><input type="text" id="lPhone" class="form-control" value="${data.phone || ''}"></div><div><label>Interest</label><input type="text" id="lInterest" class="form-control" value="${data.interest || ''}"></div></div>
                    <div class="grid-2"><div><label>Source</label><select id="lSource" class="form-control"><option>Website</option><option>Referral</option></select></div><div><label>Status</label><select id="lStatus" class="form-control"><option>New</option><option>Contacted</option><option>Qualified</option><option>Lost</option></select></div></div>
                    <div class="form-group"><label>Message</label><textarea id="lMessage" class="form-control" rows="3">${data.message || ''}</textarea></div>
                    <div style="text-align:right; margin-top:20px;"><button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button><button type="submit" class="btn-gold">Save Lead</button></div>
                </form>
            `;
            modal.style.display = 'flex';
        }
        async function saveLead(mode, id) {
            const payload = { name: document.getElementById('lName').value, email: document.getElementById('lEmail').value, phone: document.getElementById('lPhone').value, source: document.getElementById('lSource').value, status: document.getElementById('lStatus').value, message: document.getElementById('lMessage').value };
            const method = mode === 'add' ? 'POST' : 'PUT';
            const url = mode === 'add' ? `${API_BASE}/admin/leads` : `${API_BASE}/admin/leads/${id}`;
            await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
            closeModal(); navigate('leads');
        }
        async function deleteLead(id) { if(!confirm('Delete?')) return; await fetch(`${API_BASE}/admin/leads/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }}); navigate('leads'); }

        // --- UTILS & PLACEHOLDERS ---
        function renderSettings(c) { c.innerHTML = '<div class="table-card"><h3>Settings</h3></div>'; }
        function closeModal() { document.getElementById('genericModal').style.display = 'none'; }
        function logout() { localStorage.removeItem('adminToken'); window.location.href = 'admin.html'; }
        function filterTable(id) { const term = document.querySelector('input[type="text"]').value.toLowerCase(); document.querySelectorAll(`#${id} tr`).forEach(r => r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none'); }
        function toggleFields() { /* ... */ } function previewFiles() { /* ... */ } const toBase64 = f => new Promise((r,j)=>{const d=new FileReader();d.readAsDataURL(f);d.onload=()=>r(d.result);d.onerror=j});

        // Init
        if(!token) window.location.href = 'admin.html'; else navigate('dashboard');
    </script>
</body>
</html>